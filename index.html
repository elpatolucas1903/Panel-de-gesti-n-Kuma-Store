<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuma Store - Panel de Gestión</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'kuma-primary': '#8B5CF6',   // Morado Vibrante
                        'kuma-secondary': '#A78BFA', // Morado Claro
                        'kuma-dark': '#5B21B6',      // Morado Oscuro (elementos)
                        'kuma-darker': '#1E1B4B',    // Morado Casi Negro (fondo)
                        'kuma-light': '#E0E7FF',     // Lavanda Claro (texto)
                        'kuma-gray': '#64748B',      // Gris Pizarra
                    }
                }
            }
        }
    </script>
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .modal.hidden .modal-content {
            transform: scale(0.95);
        }
        /* Custom scrollbar for message modal */
        #messages-modal .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        #messages-modal .modal-content::-webkit-scrollbar-track {
            background: #1E1B4B;
        }
        #messages-modal .modal-content::-webkit-scrollbar-thumb {
            background-color: #5B21B6;
            border-radius: 10px;
            border: 2px solid #1E1B4B;
        }
        /* Sorting styles */
        .sortable {
            cursor: pointer;
            position: relative;
        }
        .sort-icon {
            display: inline-block;
            margin-left: 8px;
            opacity: 0.5;
            transition: opacity 0.2s ease;
        }
        .sortable:hover .sort-icon {
            opacity: 1;
        }
        .sort-icon.active {
            opacity: 1;
            color: #A78BFA; /* kuma-secondary */
        }
    </style>
</head>
<body class="bg-kuma-darker text-kuma-light font-sans">

    <!-- Vista Principal de la App -->
    <div id="app-view" class="min-h-screen">
        <!-- Header -->
        <header class="bg-kuma-dark p-4 shadow-lg flex justify-between items-center sticky top-0 z-20">
            <div class="flex items-center">
                <div class="w-10 h-10 mr-3">
                     <svg viewBox="0 0 100 100" class="text-kuma-primary"><path d="M50,10 C27.9,10 10,27.9 10,50 C10,72.1 27.9,90 50,90 C72.1,90 90,72.1 90,50 C90,27.9 72.1,10 50,10 Z M50,18 C67.7,18 82,32.3 82,50 C82,67.7 67.7,82 50,82 C32.3,82 18,67.7 18,50 C18,32.3 32.3,18 50,18 Z" fill="currentColor"></path><path d="M50,40 C50,40 54.3,34.2 60,32 C60,32 60,26 50,26 C40,26 40,32 40,32 C45.7,34.2 50,40 50,40 Z" fill="currentColor"></path><path d="M50,46 C40.1,46 32,54.1 32,64 L68,64 C68,54.1 59.9,46 50,46 Z" fill="currentColor"></path></svg>
                </div>
                <h1 class="text-xl font-bold">Kuma Store</h1>
            </div>
        </header>

        <main class="p-4 md:p-8">
            <!-- Panel de control -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-kuma-dark p-6 rounded-xl shadow-lg flex items-center justify-between">
                    <div>
                        <p class="text-sm text-kuma-gray">Total Clientes</p>
                        <p id="total-clients" class="text-3xl font-bold">0</p>
                    </div>
                    <div class="bg-kuma-secondary p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-kuma-darker"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    </div>
                </div>
                 <div class="bg-kuma-dark p-6 rounded-xl shadow-lg flex items-center justify-between">
                    <div>
                        <p class="text-sm text-kuma-gray">Ingresos Totales</p>
                        <p id="total-income" class="text-3xl font-bold">S/. 0.00</p>
                    </div>
                    <div class="bg-kuma-primary p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-kuma-darker"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    </div>
                </div>
            </div>

            <!-- Controles y Filtros -->
            <div class="bg-kuma-dark p-4 rounded-xl shadow-lg mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center w-full md:w-auto">
                    <input type="text" id="search-input" placeholder="Buscar por nombre, correo o WhatsApp..." class="w-full bg-kuma-darker text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-kuma-primary">
                </div>
                <div class="flex flex-wrap gap-2">
                    <button id="add-client-btn" class="bg-kuma-primary hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Añadir Cliente
                    </button>
                    <button id="config-msgs-btn" class="bg-kuma-secondary hover:bg-opacity-80 text-kuma-darker font-bold py-2 px-4 rounded-lg flex items-center transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                        Mensajes
                    </button>
                    <button id="import-data-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        Importar
                    </button>
                    <button id="export-data-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-colors">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Exportar
                    </button>
                </div>
            </div>

            <!-- Lista de Clientes -->
            <div id="client-list" class="overflow-x-auto">
                <!-- Clients will be injected here -->
                <p class="text-center text-kuma-gray py-10">Cargando clientes...</p>
            </div>
        </main>
    </div>

    <!-- Modal para Añadir/Editar Cliente -->
    <div id="client-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-30 p-4">
        <div class="modal-content bg-kuma-dark rounded-xl shadow-2xl w-full max-w-lg p-8 transform">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Añadir Nuevo Cliente</h2>
            <form id="client-form">
                <input type="hidden" id="client-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="nombre" placeholder="Nombre Cliente" class="bg-kuma-darker p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-kuma-primary" required>
                    <input type="tel" id="whatsapp" placeholder="WhatsApp (ej: 987654321)" class="bg-kuma-darker p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-kuma-primary" required>
                </div>
                <div class="mb-4">
                    <input type="email" id="correo" placeholder="Correo Cliente" class="w-full bg-kuma-darker p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-kuma-primary" required>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-sm text-kuma-gray">Fecha Activación</label>
                        <input type="date" id="fecha-activacion" class="w-full bg-kuma-darker p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-kuma-primary" required>
                    </div>
                    <div>
                        <label class="text-sm text-kuma-gray">Fecha Expiración</label>
                        <input type="date" id="fecha-expiracion" class="w-full bg-kuma-darker p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-kuma-primary">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                     <select id="producto" class="bg-kuma-darker p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-kuma-primary" required>
                         <option value="Canva Pro Edu">Canva Pro Edu</option>
                         <option value="Chat GPT Pro">Chat GPT Pro</option>
                         <option value="Perplexity">Perplexity</option>
                         <option value="Gemini Pro">Gemini Pro</option>
                     </select>
                    <input type="number" id="precio" placeholder="Precio (S/.)" class="bg-kuma-darker p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-kuma-primary" required step="0.01">
                </div>

                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" id="save-client-btn" class="bg-kuma-primary hover:bg-opacity-80 text-white font-bold py-2 px-6 rounded-lg transition-colors">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Configurar Mensajes -->
    <div id="messages-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-30 p-4">
        <div class="modal-content bg-kuma-dark rounded-xl shadow-2xl w-full max-w-2xl p-8 transform max-h-[90vh] overflow-y-auto">
             <h2 class="text-2xl font-bold mb-2">Configurar Mensajes Automáticos</h2>
             <p class="text-kuma-gray mb-4">Puedes usar <span class="font-mono text-kuma-secondary bg-kuma-darker px-1 rounded">[nombre]</span> y <span class="font-mono text-kuma-secondary bg-kuma-darker px-1 rounded">[dias]</span> como variables.</p>
             <p class="text-sm text-kuma-gray mb-6">💡 <strong>Consejo:</strong> Los emojis se mostrarán sin problemas. Para crear un salto de línea, simplemente presiona 'Enter' en el editor de texto.</p>
             <form id="messages-form" class="space-y-4">
                 <!-- Message fields will be injected here -->
             </form>
             <div class="flex justify-end gap-4 mt-8">
                 <button type="button" id="cancel-msgs-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Cancelar</button>
                 <button type="button" id="save-msgs-btn" class="bg-kuma-primary hover:bg-opacity-80 text-white font-bold py-2 px-6 rounded-lg transition-colors">Guardar Mensajes</button>
             </div>
        </div>
    </div>

    <!-- Panel Secundario para Enviar Mensajes de WhatsApp -->
    <div id="whatsapp-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-40 p-4">
        <div class="modal-content bg-kuma-dark rounded-xl shadow-2xl w-full max-w-md p-8 transform">
            <h2 id="whatsapp-modal-title" class="text-2xl font-bold mb-6">Enviar Mensaje a...</h2>
            <div id="whatsapp-templates-list" class="flex flex-wrap justify-center gap-4">
                <!-- Emoji buttons will be injected here -->
            </div>
            <div class="flex justify-end mt-8">
                <button type="button" id="cancel-whatsapp-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación de Eliminación -->
    <div id="confirm-delete-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-kuma-dark rounded-xl shadow-2xl w-full max-w-sm p-8 transform text-center">
            <h2 class="text-xl font-bold mb-4">¿Estás seguro?</h2>
            <p class="text-kuma-gray mb-6">Esta acción no se puede deshacer. El cliente será eliminado permanentemente.</p>
            <div class="flex justify-center gap-4">
                <button type="button" id="cancel-delete-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Cancelar</button>
                <button type="button" id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Importar Clientes -->
    <div id="import-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-kuma-dark rounded-xl shadow-2xl w-full max-w-2xl p-8 transform">
            <h2 class="text-2xl font-bold mb-2">Importar Clientes Masivamente</h2>
            <p class="text-kuma-gray mb-4">Pega los datos aquí, con cada cliente en una nueva línea.</p>
            <p class="text-sm text-kuma-gray mb-6">Usa el formato CSV: <code class="bg-kuma-darker text-kuma-secondary px-1 rounded">Nombre,WhatsApp,Correo,Producto,Precio,FechaActivacion,FechaExpiracion</code>. Las fechas deben estar en formato <code class="bg-kuma-darker text-kuma-secondary px-1 rounded">AAAA-MM-DD</code>.</p>
            <textarea id="import-textarea" rows="10" class="w-full bg-kuma-darker p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-kuma-primary font-mono text-sm" placeholder="Ejemplo:&#10;Juan Perez,987654321,juan@correo.com,Canva Pro Edu,8,2023-10-28,2024-10-27&#10;Maria Gomez,912345678,maria@correo.com,Chat GPT Pro,15,2023-10-29,2024-10-28"></textarea>
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" id="cancel-import-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Cancelar</button>
                <button type="button" id="save-import-btn" class="bg-kuma-primary hover:bg-opacity-80 text-white font-bold py-2 px-6 rounded-lg transition-colors">Importar Clientes</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Importa las funciones que necesitas de los SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot,
            addDoc,
            doc,
            setDoc,
            deleteDoc,
            serverTimestamp,
            query,
            getDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Configuración de la App y Firebase ---
        
        // Utiliza la configuración global si está disponible, si no, usa la de desarrollo
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyDFL9fufzIZByi1MhaFTBHCFpiC3hKv4Lw", // Restored fallback API Key from original version
                authDomain: "panel-de-gesti-n-kuma-store.firebaseapp.com",
                projectId: "panel-de-gesti-n-kuma-store",
                storageBucket: "panel-de-gesti-n-kuma-store.firebasestorage.app", // Restored fallback
                messagingSenderId: "284157387064",
                appId: "1:284157387064:web:9c600b3e9b05c4cca2e1cd"
              };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'kuma-store-crm-dev';

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Variables de estado y constantes ---
        let clientsUnsubscribe = null;
        let localClients = [];
        let messageTemplates = [];
        let clientIdToDelete = null;
        let sortColumn = 'createdAt';
        let sortDirection = 'desc';
        const MAX_MESSAGES = 10;
        
        const commandEmojis = {
            '/saludo': '✨',
            '/pasos': '🚀',
            '/confirmacion': '✅',
            '/pago': '💳',
            '/recordatorio': '👑'
        };

        const defaultMessages = [
            { command: '/saludo', text: '✨ ¡Hola! ¿Quieres *Canva Pro* en tu cuenta personal por S/.8 al año? ✨\n\nEn Kuma Store te activamos tu cuenta Canva Pro ¡con tu mismo correo! 🚀\n\n✅ Primero te activamos tu cuenta Pro, *¡luego pagas!*\n✅ ¡Disfruta de 12 meses de diseño y descargas Pro! 👑\n\n¡Me comentas si te interesa para empezar! 😉' },
            { command: '/pasos', text: '¡Perfecto! 👌\n\nEl proceso es súper simple y seguro:\n\n1️⃣ Envíanos tu correo personal 📧.\n2️⃣ Te enviaremos la invitación Pro y te avisaremos 🔔.\n3️⃣ Ingresa a tu bandeja de entrada 📥 y haz clic en "Aceptar invitación".\n4️⃣ ¡Listo! Ahora entra a Canva y comprueba 👀 que ya tienes todas las funciones premium 👑.' },
            { command: '/confirmacion', text: '¡Listo, invitación enviada! ✅\n\nRevisa tu bandeja de entrada 📥 para aceptarla.\n\n*Ojo:* Si no ves el correo, ¡no olvides buscar en la carpeta de *Spam* o *Notificaciones*!\n\nAvísanos cuando lo hayas aceptado. 😉' },
            { command: '/pago', text: '¡Genial! Me alegra que todo funcione.\n\nPuedes realizar el pago de S/.8 a través de *[Tu Método de Pago: Yape, Plin, etc.]* al número *993886442* opción otros bancos *Agora*.\n\n¡Gracias por tu confianza! 🙏' },
            { command: '/recordatorio', text: '💪 ¡Hola, [nombre]! Solo un recordatorio de lo increíble que es tu cuenta.\n\n¡Tienes *[dias] DÍAS* de Canva Pro activos y listos para la acción! 👑\n\nTienes un montón de tiempo para explorar cada herramienta y crear diseños espectaculares.\n\n¡A sacarle el máximo provecho! 🔥' }
        ];

        // --- Referencias a elementos del DOM ---
        const addClientBtn = document.getElementById('add-client-btn');
        const clientModal = document.getElementById('client-modal');
        const cancelBtn = document.getElementById('cancel-btn');
        const clientForm = document.getElementById('client-form');
        const clientList = document.getElementById('client-list');
        const searchInput = document.getElementById('search-input');
        const exportDataBtn = document.getElementById('export-data-btn');
        const saveClientBtn = document.getElementById('save-client-btn');
        const messagesModal = document.getElementById('messages-modal');
        const configMsgsBtn = document.getElementById('config-msgs-btn');
        const cancelMsgsBtn = document.getElementById('cancel-msgs-btn');
        const saveMsgsBtn = document.getElementById('save-msgs-btn');
        const messagesForm = document.getElementById('messages-form');
        const whatsappModal = document.getElementById('whatsapp-modal');
        const whatsappModalTitle = document.getElementById('whatsapp-modal-title');
        const whatsappTemplatesList = document.getElementById('whatsapp-templates-list');
        const cancelWhatsappBtn = document.getElementById('cancel-whatsapp-btn');
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const importModal = document.getElementById('import-modal');
        const importDataBtn = document.getElementById('import-data-btn');
        const cancelImportBtn = document.getElementById('cancel-import-btn');
        const saveImportBtn = document.getElementById('save-import-btn');
        
        // --- Lógica de Firestore ---
        function getCollections() {
            return {
                clientsCol: collection(db, 'artifacts', appId, 'public', 'data', 'clients'),
                messagesDoc: doc(db, 'artifacts', appId, 'public', 'data', 'config', 'messages')
            };
        }
        
        async function setupRealtimeListeners() {
            const { clientsCol, messagesDoc } = getCollections();

            try {
                const docSnap = await getDoc(messagesDoc);
                if (docSnap.exists() && docSnap.data().templates) {
                    messageTemplates = docSnap.data().templates;
                } else {
                    messageTemplates = defaultMessages;
                    await setDoc(messagesDoc, { templates: messageTemplates });
                }
            } catch (error) {
                console.error("Error loading messages:", error);
                messageTemplates = defaultMessages;
            }

            if (clientsUnsubscribe) clientsUnsubscribe();
            const q = query(clientsCol);
            clientsUnsubscribe = onSnapshot(q, (snapshot) => {
                localClients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderClients(searchInput.value.toLowerCase());
                updateDashboard();
            }, error => {
                console.error("Error fetching clients:", error);
                let errorMessage = `<strong>Error al cargar los datos.</strong>`;
                if (error.code === 'permission-denied') {
                    errorMessage = `<strong>Permiso denegado por Firestore.</strong><br>Asegúrate de que tus reglas de seguridad permitan la lectura de la colección 'clients'.`;
                } else {
                    errorMessage += `<br><small class="text-kuma-gray">Verifica la consola para más detalles.</small>`;
                }
                clientList.innerHTML = `<div class="text-center text-red-400 py-10">${errorMessage}</div>`;
            });
        }
        
        clientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            saveClientBtn.disabled = true;
            saveClientBtn.textContent = 'Guardando...';
            try {
                const id = document.getElementById('client-id').value;
                const clientData = {
                    nombre: document.getElementById('nombre').value,
                    whatsapp: document.getElementById('whatsapp').value,
                    correo: document.getElementById('correo').value,
                    fechaActivacion: document.getElementById('fecha-activacion').value,
                    fechaExpiracion: document.getElementById('fecha-expiracion').value,
                    producto: document.getElementById('producto').value,
                    precio: parseFloat(document.getElementById('precio').value) || 0,
                    estado: document.getElementById('fecha-expiracion').value ? 'Activo' : 'Contactado',
                };
                const { clientsCol } = getCollections();
                if (id) {
                    const clientRef = doc(clientsCol, id);
                    await setDoc(clientRef, { ...clientData, updatedAt: serverTimestamp() }, { merge: true });
                } else {
                    await addDoc(clientsCol, { ...clientData, createdAt: serverTimestamp() });
                }
                closeClientModal();
            } catch (error) {
                console.error("Error saving client:", error);
            } finally {
                saveClientBtn.disabled = false;
                saveClientBtn.textContent = 'Guardar';
            }
        });

        // --- Lógica de la UI y Utilidades ---
        function formatPhoneNumberForPeru(phone) {
            let cleaned = ('' + phone).replace(/\D/g, '');
            if (cleaned.startsWith('51') && cleaned.length === 11) { return cleaned; }
            if (cleaned.length === 9) { return '51' + cleaned; }
            return cleaned;
        }

        function calculateRemainingDays(expiracion) {
            if (!expiracion) return { text: 'N/A', color: 'gray', days: Infinity };
            const hoy = new Date();
            const fechaExp = new Date(expiracion + 'T00:00:00');
            hoy.setHours(0, 0, 0, 0);
            const diffTime = fechaExp - hoy;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
             if (diffDays < 0) return { text: 'Expirado', color: 'red', days: -1 };
            if (diffDays <= 7) return { text: `${diffDays} días`, color: 'yellow', days: diffDays };
            return { text: `${diffDays} días`, color: 'green', days: diffDays };
        }

        function renderClients(filterText = '') {
            let sortedClients = [...localClients];

            // Sorting logic
            sortedClients.sort((a, b) => {
                let valA, valB;

                switch (sortColumn) {
                    case 'nombre':
                        valA = a.nombre?.toLowerCase() || '';
                        valB = b.nombre?.toLowerCase() || '';
                        return valA.localeCompare(valB);
                    case 'producto':
                        valA = a.producto?.toLowerCase() || '';
                        valB = b.producto?.toLowerCase() || '';
                        return valA.localeCompare(valB);
                    case 'expiracion':
                         valA = calculateRemainingDays(a.fechaExpiracion).days;
                         valB = calculateRemainingDays(b.fechaExpiracion).days;
                         return valA - valB;
                    case 'createdAt':
                    default:
                        valA = a.createdAt?.toDate ? a.createdAt.toDate() : 0;
                        valB = b.createdAt?.toDate ? b.createdAt.toDate() : 0;
                        return valA - valB;
                }
            });

            if (sortDirection === 'desc') {
                sortedClients.reverse();
            }

            const filteredClients = sortedClients.filter(client => 
                (client.nombre?.toLowerCase() || '').includes(filterText) ||
                (client.correo?.toLowerCase() || '').includes(filterText) ||
                (client.whatsapp || '').includes(filterText)
            );

            if (filteredClients.length === 0) {
                 clientList.innerHTML = `<p class="text-center text-kuma-gray py-10">${localClients.length === 0 ? 'No hay clientes registrados. ¡Añade uno para empezar!' : 'No se encontraron coincidencias.'}</p>`;
                 return;
            }
            
            const getSortIcon = (column) => {
                if (column !== sortColumn) return `<span class="sort-icon">⇅</span>`;
                return sortDirection === 'asc' 
                    ? `<span class="sort-icon active">↑</span>` 
                    : `<span class="sort-icon active">↓</span>`;
            };
            
            const tableHTML = `
                <table class="w-full text-sm text-left text-gray-400">
                    <thead class="text-xs uppercase bg-kuma-dark">
                        <tr>
                            <th scope="col" class="px-6 py-3 sortable" data-sort="nombre">Cliente ${getSortIcon('nombre')}</th>
                            <th scope="col" class="px-6 py-3">Contacto</th>
                            <th scope="col" class="px-6 py-3 sortable" data-sort="producto">Producto/Estado ${getSortIcon('producto')}</th>
                            <th scope="col" class="px-6 py-3 sortable" data-sort="expiracion">Expiración ${getSortIcon('expiracion')}</th>
                            <th scope="col" class="px-6 py-3">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredClients.map(client => {
                            const remaining = calculateRemainingDays(client.fechaExpiracion);
                            const statusColors = { 'Activo': 'bg-green-500', 'Contactado': 'bg-blue-500', 'Expirado': 'bg-red-500' };
                            let displayStatus = client.estado;
                            let displayStatusColor = statusColors[client.estado] || 'bg-gray-500';
                            if (remaining.text === 'Expirado') {
                                displayStatus = 'Expirado';
                                displayStatusColor = statusColors['Expirado'];
                            }
                            return `
                            <tr class="border-b bg-kuma-dark border-gray-700 hover:bg-kuma-darker">
                                <td class="px-6 py-4 font-medium whitespace-nowrap text-white">${client.nombre}</td>
                                <td class="px-6 py-4"><div class="text-xs">${client.correo}</div><div class="text-xs">${client.whatsapp}</div></td>
                                <td class="px-6 py-4"><div class="font-semibold">${client.producto}</div><span class="px-2 py-1 text-xs font-medium rounded-full text-white ${displayStatusColor}">${displayStatus}</span></td>
                                <td class="px-6 py-4"><div class="font-medium text-${remaining.color}-400">${remaining.text}</div><div class="text-xs text-gray-400">${client.fechaExpiracion ? new Date(client.fechaExpiracion + 'T00:00:00').toLocaleDateString() : ''}</div></td>
                                <td class="px-6 py-4 flex items-center gap-2 flex-wrap">
                                    <button class="open-whatsapp-modal-btn bg-green-500 hover:bg-green-600 text-white p-2 rounded-full transition-colors" data-id="${client.id}" title="Enviar WhatsApp"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="pointer-events: none;"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></button>
                                    <button class="edit-btn bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-full transition-colors" data-id="${client.id}" title="Editar Cliente"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="pointer-events: none;"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></button>
                                    <button class="delete-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-full transition-colors" data-id="${client.id}" title="Eliminar Cliente"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="pointer-events: none;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
                                </td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>`;
            clientList.innerHTML = tableHTML;
        }

        function updateDashboard() {
            document.getElementById('total-clients').textContent = localClients.length;
            const totalIncome = localClients.reduce((sum, client) => sum + (client.precio || 0), 0);
            document.getElementById('total-income').textContent = `S/. ${totalIncome.toFixed(2)}`;
        }
        
        // --- Modals y Eventos ---
        function openClientModal(client = null) {
            clientForm.reset();
            if (client) {
                document.getElementById('modal-title').textContent = 'Editar Cliente';
                document.getElementById('client-id').value = client.id;
                document.getElementById('nombre').value = client.nombre;
                document.getElementById('whatsapp').value = client.whatsapp;
                document.getElementById('correo').value = client.correo;
                document.getElementById('fecha-activacion').value = client.fechaActivacion;
                document.getElementById('fecha-expiracion').value = client.fechaExpiracion;
                document.getElementById('producto').value = client.producto;
                document.getElementById('precio').value = client.precio;
            } else {
                document.getElementById('modal-title').textContent = 'Añadir Nuevo Cliente';
                document.getElementById('client-id').value = '';
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('fecha-activacion').value = today;
            }
            clientModal.classList.remove('hidden');
        }

        function closeClientModal() { clientModal.classList.add('hidden'); }

        function openWhatsappModal(client) {
            whatsappModalTitle.textContent = `Enviar Mensaje a ${client.nombre}`;
            whatsappTemplatesList.innerHTML = '';
            messageTemplates.forEach(msg => {
                const container = document.createElement('div');
                container.className = 'flex flex-col items-center w-20';
                const button = document.createElement('button');
                button.className = 'w-16 h-16 text-3xl rounded-full hover:bg-kuma-darker bg-kuma-dark transition-colors send-whatsapp-msg-btn flex items-center justify-center';
                const emoji = commandEmojis[msg.command] || '💬';
                button.innerHTML = `<span>${emoji}</span>`;
                button.dataset.phone = client.whatsapp;
                button.dataset.command = msg.command;
                button.dataset.client = JSON.stringify(client);
                const description = document.createElement('p');
                description.className = 'text-xs mt-2 text-kuma-gray capitalize text-center';
                description.textContent = msg.command.substring(1); 
                container.appendChild(button);
                container.appendChild(description);
                whatsappTemplatesList.appendChild(container);
            });
            whatsappModal.classList.remove('hidden');
        }

        function closeWhatsappModal() { whatsappModal.classList.add('hidden'); }

        function openConfirmDeleteModal(clientId) {
            clientIdToDelete = clientId;
            confirmDeleteModal.classList.remove('hidden');
        }

        function closeConfirmDeleteModal() {
            clientIdToDelete = null;
            confirmDeleteModal.classList.add('hidden');
        }

        addClientBtn.addEventListener('click', () => openClientModal());
        cancelBtn.addEventListener('click', closeClientModal);
        cancelWhatsappBtn.addEventListener('click', closeWhatsappModal);
        cancelDeleteBtn.addEventListener('click', closeConfirmDeleteModal);

        importDataBtn.addEventListener('click', () => importModal.classList.remove('hidden'));
        cancelImportBtn.addEventListener('click', () => importModal.classList.add('hidden'));

        saveImportBtn.addEventListener('click', async () => {
            const text = document.getElementById('import-textarea').value.trim();
            if (!text) return;

            saveImportBtn.disabled = true;
            saveImportBtn.textContent = 'Importando...';

            const lines = text.split('\n');
            const promises = [];
            const { clientsCol } = getCollections();

            for (const line of lines) {
                if (!line.trim()) continue;
                const parts = line.split(',').map(p => p.trim());
                if (parts.length < 5) continue; // Mínimo de campos requeridos

                const clientData = {
                    nombre: parts[0] || 'N/A',
                    whatsapp: parts[1] || '',
                    correo: parts[2] || '',
                    producto: parts[3] || 'N/A',
                    precio: parseFloat(parts[4]) || 0,
                    fechaActivacion: parts[5] || new Date().toISOString().split('T')[0],
                    fechaExpiracion: parts[6] || '',
                    createdAt: serverTimestamp()
                };
                clientData.estado = clientData.fechaExpiracion ? 'Activo' : 'Contactado';
                
                promises.push(addDoc(clientsCol, clientData));
            }

            try {
                await Promise.all(promises);
            } catch (error) {
                console.error("Error during bulk import:", error);
            } finally {
                saveImportBtn.disabled = false;
                saveImportBtn.textContent = 'Importar Clientes';
                importModal.classList.add('hidden');
                document.getElementById('import-textarea').value = '';
            }
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (clientIdToDelete) {
                try {
                    const { clientsCol } = getCollections();
                    await deleteDoc(doc(clientsCol, clientIdToDelete));
                } catch (error) {
                    console.error("Error deleting client:", error);
                } finally {
                    closeConfirmDeleteModal();
                }
            }
        });

        clientList.addEventListener('click', (e) => {
            const sortableHeader = e.target.closest('.sortable');
            if (sortableHeader) {
                const newSortColumn = sortableHeader.dataset.sort;
                if (newSortColumn === sortColumn) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = newSortColumn;
                    sortDirection = 'asc';
                }
                renderClients(searchInput.value.toLowerCase());
                return; // Prevent other actions
            }

            const editButton = e.target.closest('.edit-btn');
            if (editButton) {
                const client = localClients.find(c => c.id === editButton.dataset.id);
                openClientModal(client);
            }
            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) {
                openConfirmDeleteModal(deleteButton.dataset.id);
            }
            const openWhatsappBtn = e.target.closest('.open-whatsapp-modal-btn');
            if (openWhatsappBtn) {
                const client = localClients.find(c => c.id === openWhatsappBtn.dataset.id);
                if (client) openWhatsappModal(client);
            }
        });
        
        whatsappTemplatesList.addEventListener('click', (e) => {
            const sendButton = e.target.closest('.send-whatsapp-msg-btn');
            if (sendButton) {
                const { phone, command, client: clientJson } = sendButton.dataset;
                const clientData = JSON.parse(clientJson);
                let message = messageTemplates.find(m => m.command === command)?.text || '';
                const remaining = calculateRemainingDays(clientData.fechaExpiracion);
                const days = (remaining.text.match(/\d+/) || ['N/A'])[0];
                message = message.replace(/\[nombre\]/gi, clientData.nombre).replace(/\[dias\]/gi, days);
                const formattedPhone = formatPhoneNumberForPeru(phone);
                window.open(`https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`, '_blank');
                closeWhatsappModal();
            }
        });
        
        searchInput.addEventListener('input', (e) => renderClients(e.target.value.toLowerCase()));

        exportDataBtn.addEventListener('click', () => {
             if (localClients.length === 0) { return; }
            const headers = "Nombre,WhatsApp,Correo,Producto,Precio,Estado,FechaActivacion,FechaExpiracion";
            const csvContent = "data:text/csv;charset=utf-8," + headers + "\n" + localClients.map(c => `"${c.nombre}","${c.whatsapp}","${c.correo}","${c.producto}",${c.precio},"${c.estado}","${c.fechaActivacion}","${c.fechaExpiracion}"`).join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `kuma_store_clientes_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // --- Lógica de Mensajes ---
        function openMessagesModal() {
            messagesForm.innerHTML = '';
            for (let i = 0; i < MAX_MESSAGES; i++) {
                const msg = messageTemplates[i] || { command: '', text: '' };
                messagesForm.insertAdjacentHTML('beforeend', `
                <div class="p-4 border border-gray-700 rounded-lg">
                    <p class="text-sm font-bold mb-2">Mensaje ${i + 1}</p>
                    <input type="text" data-index="${i}" name="command" placeholder="/comando" value="${msg.command}" class="w-full bg-kuma-darker p-2 rounded-lg mb-2 focus:outline-none focus:ring-2 focus:ring-kuma-secondary">
                    <textarea data-index="${i}" name="text" placeholder="Texto del mensaje..." rows="4" class="w-full bg-kuma-darker p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-kuma-secondary">${msg.text}</textarea>
                </div>`);
            }
            messagesModal.classList.remove('hidden');
        }

        function closeMessagesModal() { messagesModal.classList.add('hidden'); }
        
        async function saveMessages() {
            const newTemplates = [];
            for (let i = 0; i < MAX_MESSAGES; i++) {
                const command = messagesForm.querySelector(`input[name="command"][data-index="${i}"]`).value;
                const text = messagesForm.querySelector(`textarea[name="text"][data-index="${i}"]`).value;
                if (command && text) { newTemplates.push({ command, text }); }
            }
            messageTemplates = newTemplates;
            const { messagesDoc } = getCollections();
            try {
                await setDoc(messagesDoc, { templates: messageTemplates });
                closeMessagesModal();
            } catch (error) { console.error("Error saving messages:", error); }
        }
        
        configMsgsBtn.addEventListener('click', openMessagesModal);
        cancelMsgsBtn.addEventListener('click', closeMessagesModal);
        saveMsgsBtn.addEventListener('click', saveMessages);

        // --- Función Principal de Inicialización ---
        async function main() {
            try {
                // Use custom token if available, otherwise sign in anonymously
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
                setupRealtimeListeners();
            } catch (error) {
                console.error("Authentication failed:", error);
                let errorMessage = `<strong>Error de Autenticación.</strong>`;
                if (error.code) {
                    switch (error.code) {
                        case 'auth/invalid-api-key':
                            errorMessage = `<strong>API Key Inválida.</strong><br>Revisa la configuración de Firebase en el código.`;
                            break;
                        case 'auth/operation-not-allowed':
                            errorMessage = `<strong>Inicio de sesión anónimo no habilitado.</strong><br>Habilita el proveedor de inicio de sesión anónimo en tu consola de Firebase.`;
                            break;
                        default:
                            errorMessage += `<br><small class="text-kuma-gray">Revisa la configuración y reglas de Firebase. Código: ${error.code}</small>`;
                    }
                }
                clientList.innerHTML = `<div class="text-center text-red-400 py-10">${errorMessage}</div>`;
            }
        }
        
        main();

    </script>

</body>
</html>

